# 安卓架构演进：整体到模块化

本文追溯了 Android 操作系统从早期版本到现代架构的演进历程。这一系列变革的核心在于**解耦**与**模块化**，旨在解决系统更新碎片化、提升安全隔离能力，并加速安全补丁的部署。

## Android 4 (2011-2013)：经典的整体式架构

![Android 4 架构](/img/Android4.png)

在 Android 4 及以前，系统呈现高度集成的“整体式”（Monolithic）结构。

- **架构特点**：
    - **应用层 (Application / Application Framework)**：开发者通过应用框架 API 与系统交互。
    - **系统运行库与核心库 (Libraries + Android Runtime)**：包含 Bionic C 库、各种媒体库以及 Dalvik 虚拟机，后者负责执行应用的 `dex` 字节码。
    - **硬件抽象层 (HAL)**：以 `.so` 动态库形式存在于 `/system` 分区，是厂商对硬件功能的具体实现，与 Android 框架紧密耦合。
    - **Linux 内核 (Linux Kernel)**：提供最基础的驱动、进程管理、内存管理（如 Ashmem）和核心 IPC机制（Binder）。

- **时代痛点**：
    - **强耦合与高昂的更新成本**：Android 框架的升级往往需要硬件厂商（Vendor）提供匹配的驱动和 HAL 实现，导致系统大版本更新缓慢且困难。
    - **较弱的隔离机制**：虽然已有 UID/GID 的权限模型，但 SELinux 在 Android 4.3 才被引入，且在 5.0 之前普遍处于“宽容模式”（Permissive），使得系统进程权限过于宽泛，漏洞利用后的横向移动相对容易。

## Android 5 (2014)：ART 运行时与 SELinux 强制化

- **变革一：Dalvik 虚拟机被 ART (Android Runtime) 取代**
    - **变动原因**：为了提升应用执行效率和启动速度。Dalvik 采用的是即时编译（JIT），而 ART 引入了预编译（AOT），在应用安装时就将 `dex` 字节码转换为本地机器码（`oat` 文件）。
    - **影响**：性能提升，系统响应更流畅；漏洞利用的复现性开始与具体的编译产物、设备配置和系统版本产生更强的关联。

- **变革二：SELinux 进入“强制模式” (Enforcing)**
    - **变动原因**：为了引入更强大的强制访问控制（MAC）机制，限制进程的行为。
    - **影响**：为每个系统服务和应用分配了特定的“安全域”（Domain），严格限制了它们可以访问的资源，极大地增加了漏洞利用后横向移动的难度。

## Android 6 (2015)：运行时权限与安全基线强化
- **运行时权限模型**：这是 Android 历史上一个里程碑式的变革。应用在安装时不再被授予所有权限，而是在首次需要访问敏感资源（如相机、联系人）时，通过弹窗动态向用户申请。这赋予了用户对数据访问的直接控制权。
- **Doze 模式与 App Standby**：引入了先进的功耗管理机制。当设备静止且未充电时，系统会进入 Doze 模式，延迟后台任务和网络访问；App Standby 则会限制不常用应用的后台活动，两者共同显著提升了电池续航。
- **强制全盘加密**：要求所有出厂搭载 Android 6.0 的新设备必须默认开启全盘加密（Full-Disk Encryption），为用户数据提供了强大的静态保护。
- **原生指纹支持**：提供了统一的指纹认证 API，使开发者可以方便地在应用中集成安全、一致的指纹识别功能。

## Android 7 (2016)：引入文件级加密与 JIT 编译器回归
- **文件级加密 (File-Based Encryption, FBE)**：取代了全盘加密，成为新的加密标准。FBE 对不同文件使用不同密钥加密，部分密钥与用户的锁屏密码绑定。
- **直接启动 (Direct Boot)**：基于 FBE，允许设备在用户输入密码前启动到一个受限模式。在该模式下，电话、闹钟等核心应用可以运行，而大部分用户数据仍处于加密状态，兼顾了便利性与安全性。
- **JIT/AOT 混合编译**：在 ART 中重新引入了 JIT 编译器，并结合 AOT 预编译。系统通过分析应用的实际使用情况（Profile-guided compilation），对热点代码进行 JIT 编译和优化，实现了应用安装速度与运行性能的平衡。
- **APK Signature Scheme v2**：引入了新的应用签名方案，通过保护 APK 的整个文件内容来防止恶意篡改，并显著加快了应用安装时的验证速度。

## Android 8 (2017)：Project Treble - 系统与供应商的解耦

- **变革核心：引入稳定的供应商接口 (Vendor Interface)**
    - **变动原因**：为了彻底解决 Android 系统更新缓慢的碎片化问题。Project Treble 将 Android OS 框架与特定于设备的底层代码（供应商实现）完全分离开。
    - **影响**：系统被明确划分为 `system` 分区和 `vendor` 分区，两者之间通过一个标准化的 HAL 接口（HIDL）通信。这使得 Google 可以独立更新 Android 系统，而无需等待芯片或设备制造商的更新。

## Android 9 (2018)：强化隐私保护与硬件安全
- **限制后台应用访问**：严格限制处于后台状态的应用访问摄像头、麦克风和传感器，防止用户在不知情的情况下被监听或追踪。
- **加密备份与 DNS over TLS**：支持使用用户锁屏密码对 Android 备份进行客户端加密。同时，原生支持 DNS over TLS，自动加密 DNS 查询，防止被窃听或篡改。
- **统一的生物识别对话框 (BiometricPrompt)**：提供了一个标准的系统级对话框，供应用调用指纹、面部或虹膜等生物识别认证，确保了体验的一致性和安全性。
- **Android 保护确认 (Android Protected Confirmation)**：利用硬件安全环境（如 TEE），在屏幕上显示一个受保护的确认提示，让用户可以安全地批准敏感交易。
- **引入 StrongBox Keymaster**：支持将私钥存储在专用的、防篡改的安全芯片中，为密钥提供最高级别的硬件保护。

## Android 10 (2019)：Project Mainline - 核心组件模块化与 APEX

- **变革核心：将关键系统组件打包成可独立更新的模块**
    - **变动原因**：即使有了 Treble，一些关键的系统级安全漏洞仍需等待数月才能通过 OTA 推送到用户设备。Mainline 旨在通过 Google Play 商店直接更新这些核心组件。
    - **影响**：引入 APEX 文件格式，用于打包和分发底层系统组件。关键漏洞可以像更新应用一样被快速修复，极大地提升了安全响应速度。

## Android 11 (2020)：GKI - 统一内核

- **变革核心：推广通用内核映像 (Generic Kernel Image)**
    - **变动原因**：尽管 Treble 解耦了 HAL，但每个设备的 Linux 内核仍然高度定制化。GKI 旨在提供一个统一的内核基础，厂商只需开发特定于其硬件的模块。
    - **影响**：将内核分为核心 GKI 部分和厂商模块，两者通过稳定的内核模块接口（KMI）交互，进一步简化了内核安全补丁的部署和更新。

## 现代 Android 架构：模块化的 culmination

![现代 Android 架构](/img/Android.webp)

经过上述一系列的演进，我们得到了“现代 Android 架构”。**这个概念并非指某一个具体的 Android 版本，而是对 Android 8.0 以来，由 Project Treble、Mainline 和 GKI 共同塑造的高度模块化、易于更新和强隔离性的系统架构的统称。**

- **核心特征**：
    - **边界固定**：通过 Treble/VINTF 明确了系统与供应商的边界。
    - **组件可更新**：通过 Mainline/APEX 实现了核心组件的独立、快速更新。
    - **强隔离**：通过强制化的 SELinux、组件化和严格的接口调用，实现了深度防御。
    - **多维版本矩阵**：理解一台设备的状态需要综合分析其平台版本、SPL、GKI 版本和 APEX 模块版本。

### Android12 (2021)：重塑隐私控制与UI
- **隐私仪表盘 (Privacy Dashboard)**：集中展示过去24小时内应用对位置、麦克风和相机的访问记录，提升透明度。
- **麦克风与摄像头指示器**：当应用使用麦克风或摄像头时，状态栏会显示明确图标，并提供快速关闭权限的开关。
- **私有计算核心 (Private Compute Core)**：创建一个安全隔离的环境，用于处理本地敏感数据和AI功能（如智能回复），数据不出设备。
- **ART 纳入 Mainline**：Android 运行时 (ART) 成为一个可更新的 Mainline 模块，使得 Google 可以通过 Play Store 直接推送运行时和核心库的改进，加速安全修复。

### Android 13 (2022)：细化权限与体验
- **照片选择器 (Photo Picker)**：允许用户只授予应用访问特定照片或视频的权限，而无需暴露整个媒体库。
- **通知运行时权限**：应用在发送通知前必须明确请求用户授权，给予用户对通知的完全控制权。
- **剪贴板自动清除**：系统在短时间内自动清除剪贴板中的敏感内容（如密码、密钥），防止被意外读取。
- **Wi-Fi 权限分离**：应用扫描附近 Wi-Fi 设备不再需要请求宽泛的位置权限，降低了不必要的数据暴露风险。

### Android 14 (2023)：强化安全基线
- **限制安装旧版应用**：为防止恶意软件利用旧版API漏洞，系统默认阻止安装面向过时 Android 版本（Android 5.1 及更早）的应用。
- **更精细的数据共享控制**：当应用试图与第三方共享位置数据时，系统会弹出额外通知，让用户决定是否批准。
- **凭据管理器 (Credential Manager)**：整合了多种认证方式，简化了登录流程，并为 Passkey 等现代认证标准提供原生支持。
- **强制要求 64 位应用**：不再支持 32 位应用，全面转向 64 位，利用现代处理器的性能和安全优势。

### Android 15 (2024)：主动防御与隐私沙盒
- **私密空间 (Private Space)**：允许用户创建一个独立的、需要额外认证才能访问的“数字保险箱”，用于隐藏和保护敏感应用。
- **盗窃保护增强**：利用 AI 检测手机是否被抢夺（例如，检测到抓取、奔跑等动作），并自动锁定屏幕，防止数据泄露。
- **部分屏幕共享**：用户可以选择只录制或共享单个应用窗口，而不是整个设备屏幕，有效防止个人信息意外暴露。
- **16KB 页面大小支持**：引入对 16KB 内存页面的支持，作为一项重要的架构转变，能够为内存密集型应用带来性能提升。

### Android 16 (2025)：AI 驱动的安全与硬件级隔离
- **高级保护计划集成**：将 Google 的高级保护计划直接集成到系统中，提供启动时验证、运行时完整性检查和硬件级内存标记等深度防御能力。
- **AI 驱动的诈骗检测**：在设备端利用 AI 实时分析应用行为和通话内容，以识别和阻止诈骗、钓鱼等恶意活动。
- **硬件强制的应用沙盒**：利用 ARM CCA (Confidential Computing Architecture) 等技术，从硬件层面强制实施应用隔离，即便系统内核被攻破，也能保护应用数据的机密性。
- **量子抗性加密**：开始部署能够抵御未来量子计算机攻击的加密算法，为长期数据安全提供保障。